<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor de archivos · BMCodigoMarret</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root { --brand:#6C5CE7; }
    body { background:#0b1220; color:#e5e7eb; }
    .card, .form-control, .btn { border-radius: 12px; }
    .glass { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); backdrop-filter: blur(6px);}
    .dropzone{ border:2px dashed rgba(255,255,255,.25); border-radius:16px; padding:28px; transition:.2s; }
    .dropzone.dragover{ background:rgba(108,92,231,.12); border-color:var(--brand);}
    .thumb{ aspect-ratio: 16/11; object-fit:cover; width:100%; border-radius:10px; }
    .skeleton{ background:linear-gradient(90deg,#2a3346 25%,#36415a 37%,#2a3346 63%); background-size:400% 100%; animation:s 1.2s ease-in-out infinite; }
    @keyframes s{ 0%{background-position:100% 50%} 100%{background-position:0 50%} }
    .btn-icon{ width:38px; height:38px; display:flex; align-items:center; justify-content:center; }
    .muted { color:#a3b1c6; }
    .search-input{ background:#0f172a; border:1px solid #1f2937; color:#e5e7eb;}
    .search-input:focus{ border-color:var(--brand); box-shadow:0 0 0 .25rem rgba(108,92,231,.25);}
    a.link { color:#a3b1c6; text-decoration:none; }
    a.link:hover { color:#fff; text-decoration:underline; }
  </style>
</head>
<body>

  <header class="container py-4">
    <div class="d-flex flex-wrap align-items-center gap-3 justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <img src="https://codigomarret.online/upload/img/loog-bm-morado-solo-fondo-blanco.png" alt="logo" width="40" height="40" class="rounded-circle">
        <div>
          <h1 class="h5 m-0">Gestor de archivos</h1>
          <div class="muted small">Sube imágenes/documentos, copia enlaces y comparte</div>
        </div>
      </div>
      <a class="link small" href="https://codigomarret.com" target="_blank">by BMCodigoMarret</a>
    </div>
  </header>

  <main class="container pb-5">
    <div class="glass p-3 p-md-4 mb-4">
      <div class="row g-3">
        <div class="col-lg-7">
          <div id="dropzone" class="dropzone text-center">
            <div class="mb-3">
              <i class="fa-solid fa-cloud-arrow-up fa-2x" style="color:var(--brand)"></i>
            </div>
            <div class="muted">Arrastra y suelta archivos aquí o</div>
            <div class="mt-2">
              <label class="btn btn-light btn-sm">
                <input id="fileInput" type="file" class="d-none" multiple>
                Elegir archivos
              </label>
            </div>
            <div class="small muted mt-2">Imágenes se optimizan a WebP en el servidor.</div>
          </div>
          <div id="uploadList" class="mt-3"></div>
        </div>

        <div class="col-lg-5">
          <label class="form-label">Buscar</label>
          <div class="d-flex gap-2">
            <input id="searchInput" type="search" class="form-control search-input" placeholder="Escribe para buscar…">
            <button id="clearBtn" class="btn btn-outline-light btn-icon" title="Limpiar">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div class="small muted mt-2">Coincide por nombre de archivo</div>
        </div>
      </div>
    </div>

    <div id="grid" class="row g-3"></div>

    <template id="cardTemplate">
      <div class="col-12 col-sm-6 col-lg-4 col-xxl-3">
        <div class="card glass h-100 p-2">
          <div class="skeleton rounded-3" style="width:100%; aspect-ratio:16/11;"></div>
          <img class="thumb d-none" loading="lazy" />
          <div class="p-2">
            <div class="small text-truncate" data-filename></div>
            <div class="d-flex gap-2 mt-2" data-actions>
              <a class="btn btn-light btn-icon" target="_blank" title="Ver"><i class="fa-regular fa-eye"></i></a>
              <button class="btn btn-secondary btn-icon" data-copy title="Copiar"><i class="fa-regular fa-copy"></i></button>
              <button class="btn btn-success btn-icon" data-dl title="Descargar"><i class="fa-solid fa-arrow-down"></i></button>
              <button class="btn btn-info btn-icon" data-share title="Compartir"><i class="fa-solid fa-share-nodes"></i></button>
              <!-- el botón Insertar (HTML) se añadirá solo para PDFs -->
              <button class="btn btn-danger btn-icon ms-auto" data-del title="Eliminar"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </div>
      </div>
    </template>
  </main>

  <script>
    // ====== Config ======
    const BASE = "https://codigomarret.online/upload";  // <— cambia si hace falta
    const API  = BASE + "/api";
    const IMG  = BASE + "/img/";

    // ====== Helpers ======
    const $ = sel => document.querySelector(sel);
    const grid = $("#grid");
    const cardTpl = $("#cardTemplate");
    const fileInput = $("#fileInput");
    const drop = $("#dropzone");
    const uploadList = $("#uploadList");
    const searchInput = $("#searchInput");
    const clearBtn = $("#clearBtn");

    const isPreviewIframe = (ext) => ["pdf","doc","docx","xlsx","xls"].includes(ext);
    const isVideo = (ext) => ["mp4","webm","mov","mkv","avi","flv"].includes(ext);
    const isAudio = (ext) => ["mp3","wav","ogg","flac","m4a"].includes(ext);

    const notify = (opts) => Swal.fire({ toast:true, position:'top-end', timer:1800, showConfirmButton:false, ...opts });

    // ========= NUEVO: copiar snippet de inserción para PDF =========
    async function copyPdfEmbed(url){
      const html = `<div style="height:70vh;width:100%">
  <object data="${url}#zoom=page-fit" type="application/pdf" width="100%" height="100%">
    <p>No se pudo mostrar el PDF.
      <a href="${url}" target="_blank" rel="noopener">Abrir / descargar</a>
    </p>
  </object>
</div>`;
      await navigator.clipboard.writeText(html);
      notify({icon:'success', title:'Código de inserción copiado'});
    }

    // ====== Render ======
    function renderSkeleton(n=8){
      grid.innerHTML = "";
      for(let i=0;i<n;i++){
        const col = document.createElement("div");
        col.className="col-12 col-sm-6 col-lg-4 col-xxl-3";
        col.innerHTML = `<div class="card glass h-100 p-2">
          <div class="skeleton rounded-3" style="width:100%; aspect-ratio:16/11;"></div>
          <div class="p-2">
            <div class="skeleton rounded-2" style="height:14px;width:70%"></div>
            <div class="d-flex gap-2 mt-2">
              <div class="skeleton rounded-2" style="height:38px;width:38px"></div>
              <div class="skeleton rounded-2" style="height:38px;width:38px"></div>
              <div class="skeleton rounded-2" style="height:38px;width:38px"></div>
            </div>
          </div>
        </div>`;
        grid.appendChild(col);
      }
    }

    function cardFor(fileName){
      const ext = (fileName.split(".").pop() || "").toLowerCase();
      const url = IMG + encodeURIComponent(fileName);
      const node = cardTpl.content.firstElementChild.cloneNode(true);
      const img = node.querySelector("img.thumb");
      const sk  = node.querySelector(".skeleton");
      const actions = node.querySelector("[data-actions]");
      node.querySelector("[data-filename]").textContent = fileName;
      node.querySelector("a").href = url;

      if(isPreviewIframe(ext)){
        const iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.className = "rounded-3";
        iframe.style.cssText="width:100%;aspect-ratio:16/11;border:0;";
        sk.replaceWith(iframe);

        // === NUEVO: botón Insertar (HTML) para PDFs ===
        if(ext === "pdf"){
          const btn = document.createElement("button");
          btn.className = "btn btn-warning btn-icon";
          btn.title = "Insertar (HTML)";
          btn.innerHTML = '<i class="fa-solid fa-code"></i>';
          btn.onclick = () => copyPdfEmbed(url);
          actions.insertBefore(btn, actions.querySelector("[data-del]"));
        }
      } else if (isVideo(ext)) {
        const video = document.createElement("video");
        video.src = url; video.controls = true; video.className="rounded-3";
        video.style.cssText="width:100%;aspect-ratio:16/11;object-fit:cover;";
        sk.replaceWith(video);
      } else if (isAudio(ext)) {
        const audio = document.createElement("audio");
        audio.src = url; audio.controls = true; audio.className="w-100";
        sk.replaceWith(audio);
      } else {
        img.src = url;
        img.onload = ()=> { sk.remove(); img.classList.remove("d-none"); };
      }

      node.querySelector("[data-copy]").onclick = async () => {
        await navigator.clipboard.writeText(url);
        notify({ icon:'success', title:'Enlace copiado' });
      };
      node.querySelector("[data-dl]").onclick = () => descargar(url);
      node.querySelector("[data-share]").onclick = () => compartir(url, fileName);
      node.querySelector("[data-del]").onclick = () => eliminar(fileName);

      return node;
    }

    function renderList(files){
      grid.innerHTML = "";
      if(!files?.length){
        grid.innerHTML = `<div class="text-center muted py-5">Sin resultados</div>`;
        return;
      }
      const frag = document.createDocumentFragment();
      files.forEach(f => frag.appendChild(cardFor(f)));
      grid.appendChild(frag);
    }

    // ====== API ======
    async function listar(){
      renderSkeleton();
      try{
        const r = await fetch(API + "/get_image");
        const j = await r.json();
        renderList(j.archivos || []);
      }catch(e){
        console.error(e);
        notify({icon:'error', title:'Error listando'});
      }
    }

    let searchTimer;
    async function buscar(term){
      if(!term) return listar();
      renderSkeleton(4);
      try{
        const r = await fetch(API + "/search_image?search=" + encodeURIComponent(term));
        const j = await r.json();
        renderList(j.imagenes || []);
      }catch(e){
        console.error(e);
        notify({icon:'error', title:'Error buscando'});
      }
    }

    async function eliminar(name){
      const ok = await Swal.fire({
        title:'Eliminar archivo',
        text:name,
        icon:'warning', confirmButtonText:'Eliminar', showCancelButton:true,
        confirmButtonColor:'#e11d48'
      }).then(r=>r.isConfirmed);
      if(!ok) return;
      try{
        const r = await fetch(API + "/delete_image?image_delete=" + encodeURIComponent(name), { method:'DELETE' });
        const j = await r.json();
        if(j.success){ notify({icon:'success', title:'Eliminado'}); listar(); }
        else { notify({icon:'error', title:j.message || 'No se pudo eliminar'}); }
      }catch(e){ console.error(e); notify({icon:'error', title:'Error eliminando'}); }
    }

    async function descargar(url){
      const r = await fetch(url);
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = decodeURIComponent(url.split('/').pop());
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function compartir(url, name){
      if(navigator.share){
        navigator.share({ title:'Archivo', text:name, url }).catch(()=>{});
      }else{
        navigator.clipboard.writeText(url);
        notify({icon:'success', title:'Enlace copiado'});
      }
    }

    // ====== Upload ======
    function renderUploadItem(file){
      const row = document.createElement('div');
      row.className = "glass p-2 rounded-3 mt-2";
      row.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <div class="flex-grow-1 text-truncate small">${file.name}</div>
          <div class="small muted" data-perc>0%</div>
        </div>
        <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-bar" style="width:0%"></div>
        </div>`;
      uploadList.appendChild(row);
      return {
        set(p){ row.querySelector('.progress-bar').style.width = p+'%'; row.querySelector('[data-perc]').textContent = p+'%'; },
        done(){ row.remove(); }
      };
    }

    function uploadFiles(files){
      [...files].forEach(file=>{
        const ui = renderUploadItem(file);
        const fd = new FormData();
        fd.append('file', file); // tu backend espera "file"

        const xhr = new XMLHttpRequest();
        xhr.open('POST', API + '/img');
        xhr.upload.onprogress = (e)=>{
          if(e.lengthComputable){
            const p = Math.round((e.loaded/e.total)*100);
            ui.set(p);
          }
        };
        xhr.onload = ()=>{
          ui.done();
          try{
            const j = JSON.parse(xhr.responseText);
            if(j.success){ notify({icon:'success', title:'Subido'}); listar(); }
            else { notify({icon:'error', title: j.message || 'Error subiendo'}); }
          }catch{ notify({icon:'error', title:'Respuesta inválida'}); }
        };
        xhr.onerror = ()=>{ ui.done(); notify({icon:'error', title:'Error de red'}); };
        xhr.send(fd);
      });
    }

    // ====== Events ======
    fileInput.addEventListener('change', e => {
      if(e.target.files?.length) uploadFiles(e.target.files);
      fileInput.value = '';
    });

    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('dragover');
      if(e.dataTransfer.files?.length) uploadFiles(e.dataTransfer.files);
    });

    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=>buscar(searchInput.value.trim()), 350);
    });
    clearBtn.addEventListener('click', () => {
      searchInput.value = ''; listar();
    });

    // ====== init ======
    listar();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
