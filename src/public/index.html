<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestor de archivos · BMCodigoMarret</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root { --brand:#6C5CE7; }
    body { background:#0b1220; color:#e5e7eb; }
    .card,.form-control,.btn { border-radius:12px; }
    .glass { background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); backdrop-filter:blur(6px); }
    .dropzone { border:2px dashed rgba(255,255,255,.25); border-radius:16px; padding:28px; transition:.2s; }
    .dropzone.dragover { background:rgba(108,92,231,.12); border-color:var(--brand); }
    .thumb { aspect-ratio:16/11; object-fit:cover; width:100%; border-radius:10px; }
    .skeleton { background:linear-gradient(90deg,#2a3346 25%,#36415a 37%,#2a3346 63%); background-size:400% 100%; animation:s 1.2s ease-in-out infinite; }
    @keyframes s { 0%{background-position:100% 50%} 100%{background-position:0 50%} }
    .btn-icon { width:38px;height:38px;display:flex;align-items:center;justify-content:center; }
    .muted { color:#a3b1c6; }
    .search-input { background:#0f172a;border:1px solid #1f2937;color:#e5e7eb; }
    .search-input:focus { border-color:var(--brand); box-shadow:0 0 0 .25rem rgba(108,92,231,.25); }
    a.link { color:#a3b1c6; text-decoration:none; } a.link:hover { color:#fff; text-decoration:underline; }
    .filename { margin-top:.35rem; font-size:.86rem; color:#cbd5e1; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; word-break:break-word; }
    .badge-chip{background:#1f2937;border:1px solid #334155;color:#cbd5e1;}
  </style>
</head>
<body>
  <header class="container py-4">
    <div class="d-flex flex-wrap align-items-center gap-3 justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <img src="https://codigomarret.online/upload/img/loog-bm-morado-solo-fondo-blanco.png" alt="logo" width="40" height="40" class="rounded-circle">
        <div>
          <h1 class="h5 m-0">Gestor de archivos</h1>
          <div class="muted small">Sube imágenes/documentos, copia enlaces y comparte</div>
        </div>
      </div>
      <a class="link small" href="https://codigomarret.com" target="_blank">by BMCodigoMarret</a>
    </div>
  </header>

  <main class="container pb-5">
    <div class="glass p-3 p-md-4 mb-4">
      <div class="row g-3">
        <div class="col-lg-7">
          <div id="dropzone" class="dropzone text-center">
            <div class="mb-3"><i class="fa-solid fa-cloud-arrow-up fa-2x" style="color:var(--brand)"></i></div>
            <div class="muted">Arrastra y suelta archivos aquí o</div>
            <div class="mt-2">
              <label class="btn btn-light btn-sm">
                <input id="fileInput" type="file" class="d-none" multiple>
                Elegir archivos
              </label>
            </div>
            <div class="small muted mt-2">Imágenes se optimizan a WebP en el servidor.</div>
          </div>
          <div id="uploadList" class="mt-3"></div>
        </div>

        <div class="col-lg-5">
          <label class="form-label">Buscar</label>
          <div class="d-flex gap-2">
            <input id="searchInput" type="search" class="form-control search-input" placeholder="Escribe para buscar…">
            <button id="clearBtn" class="btn btn-outline-light btn-icon" title="Limpiar">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          <div class="small muted mt-2">Coincide por nombre de archivo</div>
        </div>
      </div>
    </div>

    <div id="grid" class="row g-3"></div>

    <!-- Card base para archivos sueltos / fallback -->
    <template id="cardTemplate">
      <div class="col-12 col-sm-6 col-lg-4 col-xxl-3">
        <div class="card glass h-100 p-2">
          <div class="skeleton rounded-3" style="width:100%; aspect-ratio:16/11;"></div>
          <img class="thumb d-none" loading="lazy" />
          <div class="p-2">
            <div class="filename" data-filename></div>
            <div class="d-flex gap-2 align-items-center mt-2" data-actions>
              <a class="btn btn-light btn-icon" target="_blank" title="Ver"><i class="fa-regular fa-eye"></i></a>
              <button class="btn btn-secondary btn-icon" data-copy title="Copiar"><i class="fa-regular fa-copy"></i></button>
              <button class="btn btn-success btn-icon" data-dl title="Descargar"><i class="fa-solid fa-arrow-down"></i></button>
              <button class="btn btn-info btn-icon" data-share title="Compartir"><i class="fa-solid fa-share-nodes"></i></button>
              <button class="btn btn-danger btn-icon ms-auto" data-del title="Eliminar"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Card para GRUPOS de imágenes (base + variantes) -->
    <template id="groupTemplate">
      <div class="col-12 col-sm-6 col-lg-4 col-xxl-3">
        <div class="card glass h-100 p-2">
          <div class="skeleton rounded-3" style="width:100%; aspect-ratio:16/11;"></div>
          <img class="thumb d-none" loading="lazy" />
          <div class="p-2">
            <div class="filename" data-title></div>
            <div class="d-flex flex-wrap gap-1 mt-2" data-chips></div>
            <div class="d-flex gap-2 align-items-center mt-2" data-actions>
              <a class="btn btn-light btn-icon" target="_blank" title="Ver"><i class="fa-regular fa-eye"></i></a>
              <button class="btn btn-secondary btn-icon" data-copy title="Copiar enlace"><i class="fa-regular fa-copy"></i></button>
              <button class="btn btn-success btn-icon" data-dl title="Descargar"><i class="fa-solid fa-arrow-down"></i></button>
              <button class="btn btn-warning btn-icon" data-embed title="Insertar (HTML)"><i class="fa-solid fa-code"></i></button>
              <button class="btn btn-danger btn-icon ms-auto" data-del title="Eliminar grupo"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </div>
      </div>
    </template>
  </main>

  <script>
    // ====== Config ======
    // PRODUCCIÓN:
    const BASE = "https://codigomarret.online/upload";
    // DESARROLLO:
    //const BASE = "http://localhost:4000";
    const API = BASE + "/api";
    const IMG = BASE + "/img/";

    // ====== Helpers UI ======
    const $ = s => document.querySelector(s);
    const grid = $("#grid"),
      cardTpl = $("#cardTemplate"),
      groupTpl = $("#groupTemplate"),
      fileInput = $("#fileInput"),
      drop = $("#dropzone"),
      uploadList = $("#uploadList"),
      searchInput = $("#searchInput"),
      clearBtn = $("#clearBtn");

    const notify = (opts) => Swal.fire({ toast:true, position:'top-end', timer:1800, showConfirmButton:false, ...opts });

    // ====== Skeleton ======
    function renderSkeleton(n = 8) {
      grid.innerHTML = "";
      for (let i = 0; i < n; i++) {
        const col = document.createElement("div");
        col.className = "col-12 col-sm-6 col-lg-4 col-xxl-3";
        col.innerHTML = `<div class="card glass h-100 p-2">
          <div class="skeleton rounded-3" style="width:100%; aspect-ratio:16/11;"></div>
          <div class="p-2">
            <div class="skeleton rounded-2" style="height:14px;width:70%"></div>
            <div class="d-flex gap-2 mt-2">
              <div class="skeleton rounded-2" style="height:38px;width:38px"></div>
              <div class="skeleton rounded-2" style="height:38px;width:38px"></div>
              <div class="skeleton rounded-2" style="height:38px;width:38px"></div>
            </div>
          </div>
        </div>`;
        grid.appendChild(col);
      }
    }

    // ====== Utilidades ======
    function viewUrl(url) {
      const sep = url.includes("?") ? "&" : "?";
      return `${url}${sep}v=${Date.now()}`;
    }
    function extOf(name){ return (name.split('.').pop()||'').toLowerCase(); }
    function isDocLike(ext){ return ["pdf","doc","docx","xls","xlsx"].includes(ext); }
    function isVideo(ext){ return ["mp4","webm","ogg","mov","mkv","avi","flv"].includes(ext); }
    function isAudio(ext){ return ["mp3","wav","ogg","m4a","flac"].includes(ext); }

    function parseVariant(file){
      // name-720w.webp  => { base:'name', w:720, fmt:'webp' }
      // name-720w.jpg   => { base:'name', w:720, fmt:'jpg' }
      // name.jpg        => { base:'name', w:null, fmt:'jpg' }
      const m = file.match(/^(.*?)-(\d+)w\.(webp|jpe?g|png|gif|avif)$/i);
      if (m) return { base:m[1], w:parseInt(m[2],10), fmt:m[3].toLowerCase(), file };
      const ext = extOf(file);
      const base = file.replace(new RegExp("\\."+ext+"$","i"), "");
      return { base, w:null, fmt:ext, file };
    }

    function groupImages(files){
      // Agrupa por base si comparten base y patrón -{w}w.ext
      const byBase = new Map();
      for(const f of files){
        const { base, w, fmt } = parseVariant(f);
        // sólo considerar imágenes
        if (!["jpg","jpeg","png","webp","gif","avif"].includes(fmt)) continue;
        if(!byBase.has(base)) byBase.set(base, []);
        byBase.get(base).push({ file:f, w, fmt });
      }
      // separar: grupos (los que tienen >= 2 con algún -w) y archivos sueltos
      const groups = [];
      const singles = new Set(files);
      for (const [base, arr] of byBase.entries()){
        const hasW = arr.some(v => v.w);
        if (hasW && arr.length >= 2){
          groups.push({ base, variants: arr.sort((a,b)=>(a.w||0)-(b.w||0)) });
          // quitar del conjunto singles
          for(const v of arr) singles.delete(v.file);
        }
      }
      return { groups, singles:[...singles] };
    }

    // ====== Snippets ======
    async function copyPdfEmbed(url){
      const html = `<div style="height:70vh;width:100%">
  <object data="${url}#zoom=page-fit" type="application/pdf" width="100%" height="100%">
    <p>No se pudo mostrar el PDF.
      <a href="${url}" target="_blank" rel="noopener">Abrir / descargar</a>
    </p>
  </object>
</div>`;
      await navigator.clipboard.writeText(html);
      notify({ icon:'success', title:'Código de inserción copiado' });
    }

    async function copyImagePicture(baseUrl, base, variants){
      const sizes = [350,720,1080,1920];
      const hasSize = (fmt,w)=>variants.find(v=>v.fmt===fmt && v.w===w);
      const origExt = (variants.find(v=>!v.w)?.fmt) || "jpg";

      const webpSet = sizes
        .filter(w=>hasSize("webp",w))
        .map(w=>`${baseUrl}${encodeURIComponent(`${base}-${w}w.webp`)} ${w}w`)
        .join(",\n      ");

      const origSet = sizes
        .filter(w=>hasSize(origExt,w))
        .map(w=>`${baseUrl}${encodeURIComponent(`${base}-${w}w.${origExt}`)} ${w}w`)
        .join(",\n      ");

      const html = `<picture>
  ${webpSet ? `<!-- WebP -->
  <source type="image/webp"
          srcset="
      ${webpSet}
          "
          sizes="(max-width: 600px) 350px, (max-width: 1200px) 720px, 1080px" />` : ""}
  <!-- Fallback -->
  <img
    src="${baseUrl}${encodeURIComponent(base+"."+origExt)}"
    ${origSet ? `srcset="
      ${origSet}
    "` : ""}
    sizes="(max-width: 600px) 350px, (max-width: 1200px) 720px, 1080px"
    loading="lazy" decoding="async" alt="${base}" />
</picture>`;
      await navigator.clipboard.writeText(html);
      notify({ icon:'success', title:'Código <picture> copiado' });
    }

    async function chooseVariantAnd(actionLabel, variants){
      // Construye opciones: original primero si existe, luego tamaños por formato
      const opts = {};
      // original (w=null)
      const orig = variants.find(v=>v.w==null);
      if (orig) opts[orig.file] = `Original (${orig.fmt})`;
      const byFmt = {};
      for(const v of variants.filter(v=>v.w)){
        byFmt[v.fmt] ||= [];
        byFmt[v.fmt].push(v);
      }
      for(const fmt of Object.keys(byFmt)){
        for(const v of byFmt[fmt]) opts[v.file] = `${v.w}w · ${fmt}`;
      }
      const { value:file } = await Swal.fire({
        title: actionLabel,
        input: 'select',
        inputOptions: opts,
        inputPlaceholder: 'Elige una versión',
        showCancelButton: true,
        confirmButtonText: 'OK'
      });
      return file || null;
    }

    async function descargar(url){
      const r = await fetch(url);
      const blob = await r.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = decodeURIComponent(url.split('/').pop());
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function compartir(url, name){
      if (navigator.share){ navigator.share({ title:'Archivo', text:name, url }).catch(()=>{}); }
      else { navigator.clipboard.writeText(url); notify({ icon:'success', title:'Enlace copiado' }); }
    }

    // ====== Cards ======
    function cardForSingle(fileName){
      const ext = extOf(fileName);
      const urlReal = IMG + encodeURIComponent(fileName);
      const urlView = viewUrl(urlReal);

      const node = cardTpl.content.firstElementChild.cloneNode(true);
      const img = node.querySelector("img.thumb");
      const sk = node.querySelector(".skeleton");
      const acts = node.querySelector("[data-actions]");

      node.querySelector("[data-filename]").textContent = fileName;
      node.querySelector("a").href = urlReal;

      if (isDocLike(ext)){
        const iframe = document.createElement("iframe");
        iframe.src = urlView;
        iframe.className = "rounded-3";
        iframe.loading = "lazy";
        iframe.style.cssText = "width:100%;aspect-ratio:16/11;border:0;";
        sk.replaceWith(iframe);

        if (ext === "pdf") {
          const btn = document.createElement("button");
          btn.className = "btn btn-warning btn-icon";
          btn.title = "Insertar (HTML)";
          btn.innerHTML = '<i class="fa-solid fa-code"></i>';
          btn.onclick = () => copyPdfEmbed(urlReal);
          acts.insertBefore(btn, acts.querySelector("[data-del]"));
        }
      } else if (isVideo(ext)) {
        const video = document.createElement("video");
        video.src = urlView; video.controls = true; video.className = "rounded-3";
        video.style.cssText = "width:100%;aspect-ratio:16/11;object-fit:cover;";
        sk.replaceWith(video);
      } else if (isAudio(ext)) {
        const audio = document.createElement("audio");
        audio.src = urlView; audio.controls = true; audio.className = "w-100";
        sk.replaceWith(audio);
      } else {
        // imagen suelta
        const pre = new Image();
        pre.decoding = "async";
        pre.addEventListener("load", ()=>{ img.src = pre.src; img.classList.remove("d-none"); sk.remove(); });
        pre.addEventListener("error", ()=>{
          const ph = document.createElement("div");
          ph.className = "d-flex align-items-center justify-content-center bg-secondary-subtle text-secondary-emphasis rounded-3";
          ph.style.cssText = "width:100%;aspect-ratio:16/11;";
          ph.innerHTML = '<i class="fa-regular fa-image fa-2xl"></i>';
          sk.replaceWith(ph);
        });
        pre.src = urlView;
        if (pre.complete && pre.naturalWidth>0){ img.src = pre.src; img.classList.remove("d-none"); sk.remove(); }
      }

      node.querySelector("[data-copy]").onclick = async ()=>{ await navigator.clipboard.writeText(urlReal); notify({ icon:'success', title:'Enlace copiado' }); };
      node.querySelector("[data-dl]").onclick = ()=> descargar(urlReal);
      node.querySelector("[data-share]").onclick = ()=> compartir(urlReal, fileName);

      const delBtn = node.querySelector("[data-del]");
      if (delBtn) {
        delBtn.onclick = async ()=>{
          const ok = await Swal.fire({ title:'Eliminar archivo', text:fileName, icon:'warning', showCancelButton:true, confirmButtonText:'Eliminar', confirmButtonColor:'#e11d48' }).then(r=>r.isConfirmed);
          if (!ok) return;
          await fetch(API + "/delete_image?image_delete="+encodeURIComponent(fileName), { method:'DELETE' });
          notify({ icon:'success', title:'Eliminado' });
          listar();
        };
      }
      return node;
    }

    function cardForGroup(base, variants){
      // elige preview: preferimos 720w webp/jpg; si no, original
      const preview = variants.find(v=>v.w===720) || variants.find(v=>v.w===1080) || variants.find(v=>v.w===350) || variants.find(v=>v.w) || variants.find(v=>!v.w);
      const urlReal = IMG + encodeURIComponent(preview.file);
      const urlView = viewUrl(urlReal);

      const node = groupTpl.content.firstElementChild.cloneNode(true);
      const img = node.querySelector("img.thumb");
      const sk = node.querySelector(".skeleton");
      const acts = node.querySelector("[data-actions]");
      node.querySelector("[data-title]").textContent = base;

      // chips
      const chips = node.querySelector("[data-chips]");
      const fmtOrder = { webp:0, avif:1, jpg:2, jpeg:3, png:4, gif:5 };
      const sorted = [...variants].sort((a,b)=> (a.w||0)-(b.w||0) || (fmtOrder[a.fmt]??9)-(fmtOrder[b.fmt]??9));
      for (const v of sorted){
        const span = document.createElement("span");
        span.className = "badge rounded-pill badge-chip";
        span.textContent = (v.w? `${v.w}w` : 'orig') + '·' + v.fmt;
        chips.appendChild(span);
      }

      // imagen
      const pre = new Image();
      pre.decoding = "async";
      pre.addEventListener("load", ()=>{ img.src = pre.src; img.classList.remove("d-none"); sk.remove(); });
      pre.addEventListener("error", ()=>{
        const ph = document.createElement("div");
        ph.className = "d-flex align-items-center justify-content-center bg-secondary-subtle text-secondary-emphasis rounded-3";
        ph.style.cssText = "width:100%;aspect-ratio:16/11;";
        ph.innerHTML = '<i class="fa-regular fa-image fa-2xl"></i>';
        sk.replaceWith(ph);
      });
      pre.src = urlView;
      if (pre.complete && pre.naturalWidth>0){ img.src = pre.src; img.classList.remove("d-none"); sk.remove(); }

      // Ver: abre original si existe, si no la primera variante
      const aView = node.querySelector("a");
      const orig = variants.find(v=>v.w==null) || variants[0];
      aView.href = IMG + encodeURIComponent(orig.file);

      // Copiar enlace -> elige versión
      node.querySelector("[data-copy]").onclick = async ()=>{
        const chosen = await chooseVariantAnd("Copiar enlace", variants);
        if (!chosen) return;
        await navigator.clipboard.writeText(IMG + encodeURIComponent(chosen));
        notify({ icon:'success', title:'Enlace copiado' });
      };

      // Descargar -> elige versión
      node.querySelector("[data-dl]").onclick = async ()=>{
        const chosen = await chooseVariantAnd("Descargar versión", variants);
        if (!chosen) return;
        descargar(IMG + encodeURIComponent(chosen));
      };

      // Insertar (HTML) -> picture con sets disponibles
      node.querySelector("[data-embed]").onclick = ()=>{
        const baseUrl = IMG;
        copyImagePicture(baseUrl, base, variants);
      };

      // Eliminar GRUPO (fix: sólo si existe botón)
      const delBtn = node.querySelector("[data-del]");
      if (delBtn) {
        delBtn.onclick = async ()=>{
          const ok = await Swal.fire({
            title:'Eliminar grupo',
            text:`Se eliminarán ${variants.length} archivos (${base}*)`,
            icon:'warning', showCancelButton:true,
            confirmButtonText:'Eliminar', confirmButtonColor:'#e11d48'
          }).then(r=>r.isConfirmed);
          if (!ok) return;
          for (const v of variants){
            try { await fetch(API + "/delete_image?image_delete="+encodeURIComponent(v.file), { method:'DELETE' }); } catch {}
          }
          notify({ icon:'success', title:'Grupo eliminado' });
          listar();
        };
      }

      return node;
    }

    function renderList(files){
      // agrupación de imágenes + otros archivos
      const { groups, singles } = groupImages(files);

      grid.innerHTML = "";
      const frag = document.createDocumentFragment();

      // grupos primero
      for (const g of groups){
        frag.appendChild(cardForGroup(g.base, g.variants));
      }
      // archivos sueltos (los no agrupados, incluyendo no-imágenes)
      for (const f of singles){
        frag.appendChild(cardForSingle(f));
      }
      grid.appendChild(frag);
    }

    // ====== API ======
    async function listar(){
      renderSkeleton();
      try {
        const r = await fetch(API + "/get_image");
        const j = await r.json();
        renderList(j.archivos || []);
      } catch (e) {
        console.error(e);
        notify({ icon:'error', title:'Error listando' });
      }
    }

    let searchTimer;
    async function buscar(term){
      if (!term) return listar();
      renderSkeleton(4);
      try {
        const r = await fetch(API + "/search_image?search=" + encodeURIComponent(term));
        const j = await r.json();
        renderList(j.imagenes || []);
      } catch (e) {
        console.error(e);
        notify({ icon:'error', title:'Error buscando' });
      }
    }

    // ====== Upload ======
    function renderUploadItem(file){
      const row = document.createElement('div');
      row.className = "glass p-2 rounded-3 mt-2";
      row.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <div class="flex-grow-1 text-truncate small">${file.name}</div>
          <div class="small muted" data-perc>0%</div>
        </div>
        <div class="progress mt-2"><div class="progress-bar" style="width:0%"></div></div>`;
      uploadList.appendChild(row);
      return {
        set(p){ row.querySelector('.progress-bar').style.width = p + '%'; row.querySelector('[data-perc]').textContent = p + '%'; },
        done(){ row.remove(); }
      };
    }

    function uploadFiles(files){
      [...files].forEach(file=>{
        const ui = renderUploadItem(file);
        const fd = new FormData();
        fd.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', API + '/img');
        xhr.upload.onprogress = (e)=>{ if (e.lengthComputable) ui.set(Math.round((e.loaded/e.total)*100)); };
        xhr.onload = ()=>{
          ui.done();
          try {
            const j = JSON.parse(xhr.responseText);
            if (j.success) { notify({ icon:'success', title:'Subido' }); listar(); }
            else { notify({ icon:'error', title:j.message || 'Error subiendo' }); }
          } catch { notify({ icon:'error', title:'Respuesta inválida' }); }
        };
        xhr.onerror = ()=>{ ui.done(); notify({ icon:'error', title:'Error de red' }); };
        xhr.send(fd);
      });
    }

    // ====== Events ======
    fileInput.addEventListener('change', e=>{ if (e.target.files?.length) uploadFiles(e.target.files); fileInput.value=''; });
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('dragover');
      if (e.dataTransfer.files?.length) uploadFiles(e.dataTransfer.files);
    });

    searchInput.addEventListener('input', ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=> buscar(searchInput.value.trim()), 350);
    });
    clearBtn.addEventListener('click', ()=>{ searchInput.value=''; listar(); });

    // init
    listar();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
